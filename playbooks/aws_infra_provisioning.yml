---
- name: Provision VM in AWS with Terraform
  hosts: localhost

  tasks:
    - name: Git checkout the terraform code
      ansible.builtin.git:
        repo: "{{ git_repo_url }}"
        dest: /tmp/aap_tf_snow_demo
        version: main

    - name: Provision or deprovision the infra with Terraform
      cloud.terraform.terraform:
        project_path: "/tmp/aap_tf_snow_demo/terraform/aws"
        # For a destroy we need this to be absent and false
        state: "{{ infra_state }}"
        force_init: "{{ force_init }}"
        variables:
          # https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.4/html/automation_controller_user_guide/controller-credentials#access_amazon_ec2_credentials_in_an_ansible_playbook
          access_key: '{{ lookup("env", "AWS_ACCESS_KEY_ID") }}'
          secret_key: '{{ lookup("env", "AWS_SECRET_ACCESS_KEY") }}'
          webserver_count: "{{ server_count }}"
          instance_name_lb: "{{ project_name }}_lb"
          instance_name_webserver: "{{ project_name }}_web"
          project_name: "{{ project_name }}"
        backend_config:
          endpoints: "{s3 = https://{{ tf_backend_s3 }},}"
          # endpoints: "{s3 = https://{{ tf_backend_s3 }}}"  ## Expected a newline or comma to mark the beginning of the next attribute.
          ## -backend-config="endpoints={s3 = s3.openshift-storage.svc:443,}"
          # endpoints[s3]: "https://{{ tf_backend_s3 }}"  ## The backend configuration argument "endpoints[s3]" given on the command line is not expected for the selected backend type.
          ##  -backend-config 'endpoints[s3]=https://s3.openshift-storage.svc:443'
          region: "{{ tf_backend_region }}"
          bucket: "{{ tf_backend_bucket }}"
          access_key: "{{ tf_backend_access_key }}"
          secret_key: "{{ tf_backend_secret_key }}"
      register: terraformInfra

  # roles:
  #   - role: terraform-vm-provisioning
  #     vars:
  #       infra_state: "{{ infra_state }}"
  #       force_init: "{{ force_init }}"
  #       server_count: "{{ server_count }}"
  #       prefix_instance_name: "{{ instance_name }}"
  #       instance_env: "{{ instance_env }}"
  #       project_name: "{{ project_name }}"
  #       git_user: '{{ lookup("env", "git_user") }}'
  #       git_token: '{{ lookup("env", "git_token") }}'
  #       git_repo_url: "{{ git_repo_url }}"
  #       git_work_dir: "{{ git_work_dir }}"
  #       pah_pass: '{{ lookup("env", "pah_pass") }}'
  #       git_name: "AAP service account"
  #       git_email: "cloudAutomation_aap@company.com"
